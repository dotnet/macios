<!--
***********************************************************************************************
Microsoft.MaciOS.Sdk.Xcode.targets

This file contains MSBuild targets that support building and operating on Xcode projects.

***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="Sharpie"                AssemblyFile="$(_XamarinTaskAssembly)"/>
  <UsingTask TaskName="CreateXcArchive"        AssemblyFile="$(_XamarinTaskAssembly)"/>
  <UsingTask TaskName="CreateXcFramework"      AssemblyFile="$(_XamarinTaskAssembly)"/>

  <PropertyGroup>
    <_XcodeProjectDefaultOutputPathRoot>$(MSBuildProjectDirectory)/$(IntermediateOutputPath)xcode/</_XcodeProjectDefaultOutputPathRoot>
    <_BuildXcodeProjectsStamp>$(_MaciOSStampDirectory)_BuildXcodeProjects.stamp</_BuildXcodeProjectsStamp>
    <_SharpieBindXcodeProjectsStamp>$(_MaciOSStampDirectory)_SharpieBindXcodeProjects.stamp</_SharpieBindXcodeProjectsStamp>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <XcodeProject>
      <Configuration>Release</Configuration>
      <Kind>Framework</Kind>
      <OutputPath></OutputPath>
      <CreateNativeReference>true</CreateNativeReference>
      <SchemeName></SchemeName>
      <SharpieBind>false</SharpieBind>
      <SharpieNamespace></SharpieNamespace>
      <SharpieSdkName></SharpieSdkName>
      <SharpieIncludeApiDefintion>false</SharpieIncludeApiDefintion>
      <SmartLink></SmartLink>
      <Visible></Visible>
    </XcodeProject>
  </ItemDefinitionGroup>

  <Target Name="_GetBuildXcodeProjectsInputs"
      Condition=" '@(XcodeProject->Count())' != '0' " >
    <ItemGroup>
      <_AllXcbFiles Include="%(XcodeProject.RootDir)%(XcodeProject.Directory)/**/*"
          Condition= " Exists('%(XcodeProject.RootDir)%(XcodeProject.Directory)') "/>
      <_XcbInputs Include="@(_AllXcbFiles)"
          Condition="  '%(Extension)' == '.swift'
                    or '%(Extension)' == '.h'
                    or '%(Extension)' == '.pbxproj'
                    or '%(Extension)' == '.xcworkspace' " />
      <_XcbInputs Include="$(MSBuildProjectFullPath)" />
    </ItemGroup>
  </Target>

  <Target Name="_CalculateXcodeProjectOutputPaths"
        Condition=" '@(XcodeProject->Count())' != '0' "
        Outputs="%(XcodeProject.Identity)" >
    <Hash
        ItemsToHash="%(XcodeProject.Identity)"
        IgnoreCase="true" >
      <Output TaskParameter="HashResult" PropertyName="_XcodeProjectHash" />
    </Hash>
    <ItemGroup>
      <XcodeProject Condition=" '%(XcodeProject.OutputPath)' == '' " >
        <OutputPath>$(_XcodeProjectDefaultOutputPathRoot)%(SchemeName)-$([System.String]::Copy($(_XcodeProjectHash)).Substring(0, 5))/</OutputPath>
      </XcodeProject>
    </ItemGroup>
  </Target>

  <Target Name="_BuildXcodeProjects"
      Condition=" '@(XcodeProject->Count())' != '0' "
      DependsOnTargets="_BuildXcodeProjectFrameworks;_SharpieBindXcodeProjects" >
  </Target>

  <Target Name="_BuildXcodeProjectFrameworks"
      Condition=" '@(XcodeProject->Count())' != '0' "
      DependsOnTargets="_GetBuildXcodeProjectsInputs;_CalculateXcodeProjectOutputPaths;_DetectSdkLocations"
      Inputs="@(_XcbInputs)"
      Outputs="$(_BuildXcodeProjectsStamp)" >
    <RemoveDir Directories="@(XcodeProject->'%(OutputPath)archives')" />
    <RemoveDir Directories="@(XcodeProject->'%(OutputPath)xcframeworks')" />

    <PropertyGroup>
      <_XcArchivePlatform Condition=" '$(TargetPlatformIdentifier)' == 'maccatalyst' ">generic/platform=macOS,variant=Mac Catalyst</_XcArchivePlatform>
      <_XcArchivePlatform Condition=" '$(TargetPlatformIdentifier)' == 'tvos' ">generic/platform=iOS</_XcArchivePlatform>
      <_XcArchivePlatform Condition=" '$(_XcArchivePlatform)' == '' ">generic/platform=$(TargetPlatformIdentifier)</_XcArchivePlatform>
    </PropertyGroup>

    <!-- Create XCARCHIVE for $(TargetPlatformIdentifier) -->
    <!-- The derivedDataPath and packageCachePath arguments are used to better support multitargeting -->
    <CreateXcArchive
        ProjectPath="%(XcodeProject.FullPath)"
        SchemeName="%(XcodeProject.SchemeName)"
        Configuration="%(XcodeProject.Configuration)"
        ArchivePlatform="$(_XcArchivePlatform)"
        OutputPath="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcarchive"
        DerivedDataPath="$(_XcodeProjectDefaultOutputPathRoot)DerivedData"
        PackageCachePath="$(_XcodeProjectDefaultOutputPathRoot)Cache"
        SdkDevPath="$(_SdkDevPath)"
        WorkingDirectory="%(XcodeProject.RootDir)%(XcodeProject.Directory)" >
    </CreateXcArchive>

    <!-- Create simulator XCARCHIVE for $(TargetPlatformIdentifier) -->
    <CreateXcArchive
        Condition=" '$(TargetPlatformIdentifier)' == 'ios' or  '$(TargetPlatformIdentifier)' == 'tvos' "
        ProjectPath="%(XcodeProject.FullPath)"
        SchemeName="%(XcodeProject.SchemeName)"
        Configuration="%(XcodeProject.Configuration)"
        ArchivePlatform="$(_XcArchivePlatform) Simulator"
        DerivedDataPath="$(_XcodeProjectDefaultOutputPathRoot)DerivedData"
        PackageCachePath="$(_XcodeProjectDefaultOutputPathRoot)Cache"
        OutputPath="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier)Simulator.xcarchive"
        SdkDevPath="$(_SdkDevPath)"
        WorkingDirectory="%(XcodeProject.RootDir)%(XcodeProject.Directory)" >
    </CreateXcArchive>

    <!-- Create XCFRAMEWORK for $(TargetPlatformIdentifier) -->
    <!-- TODO Sign the XCFramework bundle? Looks like this is done via _CodesignAppBundle but may need to sign nested content? -->
    <ItemGroup>
      <_XcArchiveOutputs Include="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcarchive" />
      <_XcArchiveOutputs Include="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier)Simulator.xcarchive"
          Condition=" Exists('%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier)Simulator.xcarchive') "/>
    </ItemGroup>
    <CreateXcFramework
        FrameworkArchives="@(_XcArchiveOutputs)"
        FrameworkName="%(XcodeProject.SchemeName).framework"
        OutputPath="%(XcodeProject.OutputPath)xcframeworks/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcframework"
        SdkDevPath="$(_SdkDevPath)"
        WorkingDirectory="%(XcodeProject.RootDir)%(XcodeProject.Directory)" >
    </CreateXcFramework>

    <ItemGroup>
      <_XcodeProjectXcFrameworkOutputs Include="%(XcodeProject.OutputPath)xcframeworks/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcframework"
          Condition=" '%(CreateNativeReference)' == 'true' "
          Kind="%(Kind)"
          SmartLink="%(SmartLink)"
          Visible="%(Visible)" />
    </ItemGroup>

    <Message Text="Adding reference to Xcode project output: '%(_XcodeProjectXcFrameworkOutputs.Identity)'. The '%25(CreateNativeReference)' metadata can be set to 'false' to opt out of this behavior." Importance="high" />

    <Touch Files="$(_BuildXcodeProjectsStamp)" AlwaysCreate="true" />
    <ItemGroup>
      <!-- Add stamp and build outputs to FileWrites so they are not deleted on IncrementalClean -->
      <FileWrites Include="$(_BuildXcodeProjectsStamp);%(XcodeProject.OutputPath)**/*" />
      <!-- Automatically add XCFRAMEWORK outputs to be bound or otherwise processed later in the build -->
      <NativeReference Include="@(_XcodeProjectXcFrameworkOutputs)" Kind="%(Kind)" SmartLink="%(SmartLink)" Visible="%(Visible)" />
    </ItemGroup>
  </Target>


  <Target Name="_GetSharpieBindInputs"
      Condition=" '$(IsBindingProject)' == 'true' and '@(XcodeProject->Count())' != '0' and '@(XcodeProject->'%(SharpieBind)')' == 'true' " >
    <ItemGroup>
      <_SharpieInputs Include="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcarchive" />
    </ItemGroup>
  </Target>

  <Target Name="_SharpieBindXcodeProjects"
      Condition=" '$(IsBindingProject)' == 'true' and '@(XcodeProject->Count())' != '0' and '@(XcodeProject->'%(SharpieBind)')' == 'true' "
      DependsOnTargets="_GetSharpieBindInputs;_DetectSdkLocations"
      Inputs="@(_SharpieInputs)"
      Outputs="$(_SharpieBindXcodeProjectsStamp)">
    <RemoveDir Directories="@(XcodeProject->'%(OutputPath)sharpie')" />

    <Sharpie Command="bind"
        Namespace="%(XcodeProject.SharpieNamespace)"
        Sdk="%(XcodeProject.SharpieSdkName)"
        OutputPath="%(XcodeProject.OutputPath)sharpie/%(XcodeProject.Filename)"
        Scope="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcarchive/Products/Library/Frameworks/%(XcodeProject.SchemeName).framework/Headers"
        Headers="%(XcodeProject.OutputPath)archives/%(XcodeProject.SchemeName)$(TargetPlatformIdentifier).xcarchive/Products/Library/Frameworks/%(XcodeProject.SchemeName).framework/Headers/%(SchemeName)-Swift.h"
        SdkDevPath="$(_SdkDevPath)" >
    </Sharpie>

    <Touch Files="$(_SharpieBindXcodeProjectsStamp)" AlwaysCreate="true" />
    <ItemGroup>
      <!-- Add stamp and build outputs to FileWrites so they are not deleted on IncrementalClean -->
      <FileWrites Include="$(_SharpieBindXcodeProjectsStamp);%(XcodeProject.OutputPath)sharpie/**/*" />
      <!-- Add ApiDefinition output to be processed later in the build -->
      <ObjcBindingApiDefinition Include="%(XcodeProject.OutputPath)sharpie/%(XcodeProject.Filename)/ApiDefinition.cs"
          Condition=" '%(SharpieIncludeApiDefintion)' == 'true' " />
    </ItemGroup>
  </Target>


  <Target Name="_CleanXcodeProjects"
      Condition=" '@(XcodeProject->Count())' != '0' "
      DependsOnTargets="_GetBuildXcodeProjectsInputs;_CalculateXcodeProjectOutputPaths" >
    <RemoveDir Directories="@(XcodeProject->'%(OutputPath)')" />
  </Target>

</Project>
