steps:

- bash: |
    sudo rm -Rf $(Build.SourcesDirectory)/artifacts
  displayName: "Remove artifacts"
  condition: always()

# use a diff step depending if we have been trigger by a pipeline of by a PR/Commit
- ${{ if or(contains(variables['Build.Reason'], 'ResourceTrigger'), contains(variables['Build.Reason'], 'BuildCompletion')) }}:
  - download: macios
    displayName: Download PkgsVersions.json
    patterns: '**/PkgsVersions.json'

  - download: macios
    displayName: Download WorkloadRollback.json
    patterns: '**/WorkloadRollback.json'

  - download: macios
    displayName: Download packages
    artifact: not-signed-package

  - download: macios
    displayName: Download test libraries
    artifact: package-test-libraries

  # the default location when downloading is $(Pipeline.Workspace)/<pipeline resource identifier>/<artifact name>
  - pwsh: |
      $source = "$(Pipeline.Workspace)/macios"
      $destination = "$(Build.SourcesDirectory)/artifacts
      New-Item -ItemType Directory -Force -Path $destination
      Write-Host "Moving content from $source to $destination"
      # move all the files from the source to the destination
      Get-ChildItem -Path $source -Recurse -File | Move-Item -Destination $destination
    displayName: Move artifacts to the expected location

- ${{ else }}:
  - task: DownloadPipelineArtifact@2
    displayName: Download PkgsVersions.json
    inputs:
      allowFailedBuilds: true
      patterns: '**/PkgsVersions.json'
      path: $(Build.SourcesDirectory)/artifacts

  - task: DownloadPipelineArtifact@2
    displayName: Download WorkloadRollback.json
    inputs:
      allowFailedBuilds: true
      patterns: '**/WorkloadRollback.json'
      path: $(Build.SourcesDirectory)/artifacts

  - task: DownloadPipelineArtifact@2
    displayName: Download packages
    inputs:
      allowFailedBuilds: true
      artifactName: not-signed-package
      path: $(Build.SourcesDirectory)/artifacts/not-signed-package

  - task: DownloadPipelineArtifact@2
    displayName: Download test libraries
    inputs:
      allowFailedBuilds: true
      artifactName: package-test-libraries
      path: $(Build.SourcesDirectory)/artifacts/package-test-libraries

# print the downloads to make our life easier on debug
- pwsh: |
    Get-ChildItem -Path $(Build.SourcesDirectory)/artifacts -Recurse -Force
  displayName: 'Display downloads'
  timeoutInMinutes: 5
