# generic steps to get the test results, remove any private informaiton and add them to the github page.
parameters:

- name: reason 
  type: string 
  default: 'pr' # default reason is a pr build 

- name: devicePrefix
  type: string 
  default: 'sim' # always sim, but use a param to move in the future if needed

steps:

- checkout: self
  persistCredentials: true

# downlod ALL artifacts
- download: macios 

- pwsh: |
    $configFile = Join-Path $(PIPELINE.WORKSPACE) "macios" "build-configuration" "configuration.json"
    $config = Get-Content $configFile | ConvertFrom-Json
    # export variables to be present in the othe steps
    Write-Host "##vso[task.setvariable variable=BuildReason;isOutput=true]$($config.BuildReason)"
    Write-Host "##vso[task.setvariable variable=BuildSourceBranchName;isOutput=true]$($config.BuildSourceBranchName)"
    Write-Host "##vso[task.setvariable variable=BuildSourceBranch;isOutput=true]$($config.BuildSourceBranch)"
    Write-Host "##vso[task.setvariable variable=BuildId;isOutput=true]$($config.BuildId)"
    Write-Host "##vso[task.setvariable variable=Commit;isOutput=true]$($config.Commit)"
  name: configuration
  displayName: 'Parse build configuration'
  timeoutInMinutes: 1

- pwsh: |
    $downloadsPath = Join-Path $(PIPELINE.WORKSPACE) "macios"
    Get-ChildItem  $downloadsPath -Recurse
    # show all the paths to remove
    Get-ChildItem -Path $downloadsPath -Filter *.log -Recurse -File | ForEach-Object {
      Write-Host "Log to remove $_"
    }
  displayName: 'Remove private logs'
  timeoutInMinutes: 10

- pwsh: |
    git config user.email "valco@microsoft.com"
    git config user.name "vs-mobiletools-engineering-service2"

    $branchName = "$Env:OriginalSourceBranch/$Env:OriginalCommit/$Env:OriginalBuildId"
    if ($Env:OriginalBuildReason -eq "PullRequest") {
      $branchName = "pr/$branchName"
    } else {
      $branchName = "ci/$branchName"
    }

    Write-Host "New branch name: $branchName"
    $htmlRepo = Join-Path $(Build.SourcesDirectory) "macios.ci"
    cd $htmlRepo 
    git checkout -b $branchName 
  displayName: 'Create remote branch'
  timeoutInMinutes: 10
  env:
    OriginalBuildReason: $(configuration.BuildReason)
    OriginalSourceBranch: $(configuration.BuildSourceBranchName)
    OriginalBuildId: $(configuration.BuildId)
    OriginalCommit: $(configuration.Commit)


