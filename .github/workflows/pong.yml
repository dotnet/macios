name: Update local copy

on: repository_dispatch

jobs:
  updateRemote:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@master

      - name: 'Debug context'
        run: echo "$GITHUB_CONTEXT"
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: 'Add remotes'
        run: |
          git remote add public "http://$Env:GITHUB_TOKEN@github.com/xamarin/xamarin-macios.git"
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.access-token }}

      - name: 'Fetch remote'
        run: git fetch public

      - name: 'Update local branch'
        run: |
          git checkout $Env:BRANCH
          git pull public $Env:BRANCH
          git push origin $Env:BRANCH
        shell: pwsh
        env:
          BRANCH: ${{ github.event.branch }}

      - name: 'Update local branch'
        run: |
          git checkout -b $Env:BRANCH-private
          git merge $Env:BRANCH
          git push origin $Env:BRANCH-private
        shell: pwsh
        env:
          BRANCH: ${{ github.event.branch }}