<Project>
  <!-- Do not sign files that already have a signature -->
  <ItemGroup>
    <Skip Include="Mono.Options.dll" />
    <Skip Include="System.Reflection.MetadataLoadContext.dll" />
    <!-- Microsoft.iOS.Windows.Sdk content -->
    <Skip Include="tools\msbuild\iOS\Microsoft.Win32.Registry.dll" />
    <Skip Include="tools\msbuild\iOS\System.Buffers.dll" />
    <Skip Include="tools\msbuild\iOS\System.Memory.dll" />
    <Skip Include="tools\msbuild\iOS\System.Numerics.Vectors.dll" />
    <Skip Include="tools\msbuild\iOS\System.Runtime.CompilerServices.Unsafe.dll" />
    <Skip Include="tools\msbuild\iOS\System.Security.AccessControl.dll" />
    <Skip Include="tools\msbuild\iOS\System.Security.Cryptography.Pkcs.dll" />
    <Skip Include="tools\msbuild\iOS\System.Security.Cryptography.ProtectedData.dll" />
    <Skip Include="tools\msbuild\iOS\System.Security.Principal.Windows.dll" />
    <Skip Include="tools\msbuild\iOS\ws2_32.dll" />
    <!-- Broker.zip -->
    <Skip Include="Broker\Newtonsoft.Json.dll" />
    <Skip Include="Broker\System.Net.Mqtt.dll" />
    <Skip Include="Broker\System.Net.Mqtt.Server.dll" />
    <Skip Include="Broker\System.Reactive.dll" />
    <Skip Include="Broker\System.Runtime.CompilerServices.Unsafe.dll" />
    <Skip Include="Broker\System.Security.Cryptography.ProtectedData.dll" />
    <Skip Include="Broker\System.Threading.Tasks.Extensions.dll" />
    <Skip Include="Broker\System.ValueTuple.dll" />
    <!-- Build.zip -->
    <Skip Include="Build\Microsoft.Bcl.AsyncInterfaces.dll" />
    <Skip Include="Build\System.Buffers.dll" />
    <Skip Include="Build\System.Collections.Immutable.dll" />
    <Skip Include="Build\System.Memory.dll" />
    <Skip Include="Build\System.Numerics.Vectors.dll" />
    <Skip Include="Build\System.Reflection.Metadata.dll" />
    <Skip Include="Build\System.Resources.Extensions.dll" />
    <Skip Include="Build\System.Runtime.CompilerServices.Unsafe.dll" />
    <Skip Include="Build\System.Text.Encodings.Web.dll" />
    <Skip Include="Build\System.Text.Json.dll" />
    <Skip Include="Build\System.Threading.Tasks.Dataflow.dll" />
    <Skip Include="Build\System.Threading.Tasks.Extensions.dll" />
  </ItemGroup>

  <ItemGroup>
    <ThirdParty Include="BouncyCastle.Crypto.dll" />
    <ThirdParty Include="imobiledevice-*\*.dll" />
    <ThirdParty Include="imobiledevice-*\*.exe" />
    <!-- Build.zip -->
    <ThirdParty Include="Mono.Cecil*.dll" />
  </ItemGroup>

  <ItemGroup>
    <FirstParty Include="bgen.dll" />
    <FirstParty Include="dotnet-linker.dll" />
    <FirstParty Include="Xamarin.*.dll" />
    <!-- mlaunch.app MonoBundle content-->
    <FirstParty Include="mlaunch.exe" />
    <FirstParty Include="Mono.Security.dll" />
    <FirstParty Include="mscorlib.dll" />
    <FirstParty Include="System.Core.dll" />
    <FirstParty Include="System.dll" />
    <FirstParty Include="System.Numerics.dll" />
    <FirstParty Include="System.Xml.dll" />
    <!-- Microsoft.iOS.Windows.Sdk content -->
    <FirstParty Include="iSign.Core.dll" />
    <FirstParty Include="System.Diagnostics.Tracer.dll" />
    <!-- Broker.zip -->
    <FirstParty Include="Broker.exe" />
    <FirstParty Include="Merq.dll" />
    <!-- Build.zip -->
    <FirstParty Include="Build.exe" />
    <FirstParty Include="Microsoft.Build*.dll" />
    <FirstParty Include="Microsoft.NET.StringTools.dll" />
    <FirstParty Include="System.IO.Abstractions.dll" />
    <!-- Xamarin.PreBuilt.iOS.app.zip -->
    <FirstParty Include="Xamarin.PreBuilt.iOS.app\*.dll" />
  </ItemGroup>

  <!-- Extensions for signing nested .zip files for https://github.com/xamarin/yaml-templates/blob/e0f3cdce6210e05495188def8c695372b64ada1d/sign-artifacts/steps/v2-SignFiles.proj -->
  <Target Name="_UnzipNestedZips"
      BeforeTargets="_CalculateItemsToSign">
    <PropertyGroup>
      <_NestedZipExtractionDir>$(_WorkingDir)nested\</_NestedZipExtractionDir>
    </PropertyGroup>

    <ItemGroup>
      <_NestedBrokerZip Include="$(_WorkingDir)**\Broker.zip" />
      <_NestedBuildZip Include="$(_WorkingDir)**\Build.zip" />
      <_NestediOSAppZip Include="$(_WorkingDir)**\Xamarin.PreBuilt.iOS.app.zip" />
    </ItemGroup>

    <RemoveDir Directories="$(_NestedZipExtractionDir)" />
    <Unzip
        SourceFiles="@(_NestedBrokerZip)"
        DestinationFolder="@(_NestedBrokerZip -> '$(_NestedZipExtractionDir)%(Filename)')"
    />
    <Delete Files="@(_NestedBrokerZip)" />

    <Unzip
        SourceFiles="@(_NestedBuildZip)"
        DestinationFolder="@(_NestedBuildZip -> '$(_NestedZipExtractionDir)%(Filename)')"
    />
    <Delete Files="@(_NestedBuildZip)" />

    <Unzip
        SourceFiles="@(_NestediOSAppZip)"
        DestinationFolder="@(_NestediOSAppZip -> '$(_NestedZipExtractionDir)%(Filename)')"
    />
    <Delete Files="@(_NestediOSAppZip)" />
  </Target>

  <Target Name="_ZipNestedZips"
      DependsOnTargets="_UnzipNestedZips"
      AfterTargets="SignFiles" >
    <ZipDirectory
        SourceDirectory="@(_NestedBrokerZip -> '$(_NestedZipExtractionDir)%(Filename)')"
        DestinationFile="@(_NestedBrokerZip)"
    />
    <ZipDirectory
        SourceDirectory="@(_NestedBuildZip -> '$(_NestedZipExtractionDir)%(Filename)')"
        DestinationFile="@(_NestedBuildZip)"
    />
    <ZipDirectory
        SourceDirectory="@(_NestediOSAppZip -> '$(_NestedZipExtractionDir)%(Filename)')"
        DestinationFile="@(_NestediOSAppZip)"
    />
    <RemoveDir Directories="$(_NestedZipExtractionDir)" />
  </Target>

</Project>
